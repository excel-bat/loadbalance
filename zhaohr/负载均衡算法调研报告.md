# 负载均衡算法调研报告

赵浩然

---

## 问题背景

负载均衡问题的三个因素：算法、网络拓扑、负载均衡力度。
负载均衡算法主要分分静态负载均衡和动态负载均衡。
**静态负载均衡**：预先设定分配方案，随机轮询权重。问题：影响客户访问频率的因素很多，难以预测，静态调度结果不好。
**动态负载均衡**：根据负载信息的获取又可分为：基于请求内容和基于真实节点负载。
**基于请求内容**：真实节点的负载是由于处理请求产生的，通过请求本身的信息（处理文件的长度、类型等）定义它的单位处理时间，通过统计服务器节点上所有请求对应的处理时间描述负载情况。
**基于真实节点负载**：直接收集后台服务器信息。对一台服务器处理能力的计算一般要考虑多种因素：CPU资源，内存资源，系统当前进程数，磁盘I/O频度和响应时间等。这样描述的难度在于需要为这些因素选择合适的计算系数。另一个问题在于不断读取后台负载会导致额外开销。若间歇收集负载信息，不准确及时的信息可能会误导算法，破坏均衡。


常见的静态算法：轮询、加权轮询
常见的动态算法：最小连接、响应速度（时间）、动态反馈DFB、Pick-KX

其中DFB指根据实时负载表记录的后台硬件信息计算出一个值来调度。考虑了系统处理能力，未考虑当前负载。Pick-KX在算法中引入一定随机性来改善性能，考虑了负载情况，没有考虑处理能力

评判标准：系统开销，资源利用率，适应性，可靠性，响应时间，复杂性等。

---

## 得到系统负载压力或权值（负载能力）的方法：

### 1.基础的基于定期收集后台信息的负载动态平衡设计
郭全生,舒继武,毛希平,温冬蝉,郑纬民.基于LVS系统的负载动态平衡设计与实现[J].计算机研究与发展,2004(06):923-929.

基础的定时获取后台信息，进行数据处理与权值计算。最后按加权轮询分配。

特点是调整后台服务器权重时不是直接替换，引入了计算公式，保证收敛同时剔除小概率事件影响，稳定性好，同时也意味着灵敏性差。

**缺点**：按经验设置后台参数系数，且此系数不变；没有对获取信息的时间间隔优化；当整个集群处于超载或轻负载状态时，效果可能不好。

### 2.用方差动态求取后台参数系数，适应任务间需求差异明显的情况
段赵磊,古志民.一种自适应的网络代理集群负载均衡策略[J].计算机工程,2010,36(01):97-98+101.
段赵磊,黄艳.弹性Web Cache集群的自适应负载均衡策略[J].小型微型计算机系统,2013,34(07):1527-1530.

提出后台节点负载计算公式，对每个服务端，计算公式的参数通过最近m个负载采样与请求平均处理时间的方差来求得。

计算出负载后提出了新的权重和分配算法（好像和加权轮询差不多）

**优点**：适用于任务资源需求差异明显的情况。
**缺点**：对负载情况的计算量大，开销大。

### 3.通过观察服务器请求个数与响应时间的规律，用初始权值和响应时间动态反映负载情况
郑祺.一种基于WEB集群的负载均衡算法[J].计算机系统应用,2009,18(7):76-79.

节点的初始权值计算：考虑的参数有CPU处理速度、内存容量、系统I/O速率、网络带宽。按照系数加权得到节点的初始权值（负载能力）。
观察单台服务器请求个数与相应个数、响应时间的规律，发现可以用响应时间来衡量当前节点状态。具体为找到由于请求个数过多进入假死状态时的最大响应时间Tmax和只有一个最基本请求任务时的基础响应时间Tbas，以及得到当前响应时间Tnow，按公式对初始权值计算得到动态权值。
此外，根据上述观察发现的规律，当服务期接近饱和状态时，即响应时间接近Tmax时，引入调节系数K，适时降低权值，抑制服务器进入饱和状态。
设置参数表示突发状态，并引入参数对突发状态做动态调整。
综合以上给出最终动态权值。

**优点**：1.与定时采集后台所有数据相比，只需得到响应时间，减轻了采集参数和权值计算的负担。实现简单。2.考虑了后端服务器临界情况和网络数据突发情况，动态适应性更强。

**缺点**：1.仍需根据系统测试情况设置初始权值的参数系数。2.算法规则是根据对单台服务器的响应状况观察得出。在要应用的服务器上是否有同样规律，算法可移植性未知。


---

## 基于内容的负载均衡算法

任彦琦,彭勤科,胡保生.一种基于内容的Web集群服务器负载均衡算法[J].计算机工程,2005(02):122-124+181.
任国庆,杨金民,张大方.基于内容的Web服务器动态负载均衡算法[J].计算机工程,2010,36(13):82-83+86.

---

## 得到负载后的选择算法：Pick-K、Pick-KX、Pick-T算法

以下讨论算法时，假设有N台服务器，定期更新一个记录各成员服务器目前负载情况的列表，更新周期为T。

###1. Pick-K算法
描述：在更新周期$T$内，当有任务到来，从$N$台成员服务器中选择任意$K$个服务器，根据列表比较负载情况，选一个负载最小的发送。
特殊情况：$K=N$，总是选择负载最低的服务器；$K=1$，随机分配。
效果：负载信息及时的时候效果很好。
问题：负载信息不准确及时，效果较差。
结论：大多数情况下K=2效果最好。

###2. Pick-KX算法
描述：同样的在更新周期$T$内，当有任务到来，从$N$台成员服务器中选任意$K$个服务器，并设它们的负载为$L_1, L_2,...,L_K$。不选择负载最小的，而是按公式计算分配给第$j$个服务器的概率$P_j$：
$$
\begin{aligned}
&L_{total}=\sum_{i=1}^KL_i\\
&X_j=\frac{L_{total}-L_j}{L_{total}} &j=1,2,...,K\\
&P_j=X_j/\sum_{i=1}^KX_i    &j=1,2,...,K
\end{aligned}
$$

效果：计算复杂，但均衡效果较Pick-K有较大改善，且当更新周期T较长时表现更好。

###3. Pick-T算法
描述：在更新周期$T$内设$N$台服务器的对应负载状态为$L_1<L_2<L_3<...<L_N$，按公式计算分配给第$j$个服务器的概率$Pj$：
其中$n_T=\lambda·T$，$\lambda$为单位时间到达任务数。

$$
\begin{aligned}
&L_{total}=\sum_{i=1}^{min(\lfloor{n_T}\rfloor,N)}L_i\\
&X_j=\frac{L_{total}-L_j}{L_{total}} &j=1,2,...,min(\lfloor{n_T}\rfloor,N)\\
\end{aligned}
$$
$$
P_j=\left\{
\begin{aligned}
&\frac{X_j}{\sum_{i=1}^{min(\lfloor{n_T}\rfloor,N)}X_i}
&1<j\leq min(\lfloor{n_T}\rfloor,N)\\
&0
&\lfloor{n_T}\rfloor <j\leq N
\end{aligned}
\right.
$$

特殊情况：$n_r=1$近似满足服务器负载状态实时更新，计算得$P_1=1$，即选择负载最小的服务器。
$n_r\geq N$，Pick-T算法等价于Pick-NX算法。

###4. 三者比较：

算法 | 系统资源消耗 | 负载均衡 | 服务延迟
- | - | - | - | 
Pick-K | 中 | 适用于更新周期较短 | 大
Pick-KX | 大 | 适用于更新周期较长 | 中
Pick-T | 小 | 中和 | 小


---
## 其他思路
1.先按负载情况对服务器聚类，选择负载最轻那一类，在其中分配。分配时不考虑负载情况（因为这一类的服务器负载大致相同），只考虑处理能力。
黄倩. web集群负载均衡系统的设计与实现[D].电子科技大学,2014.

2.通过单机测试得到不同后台参数对服务器性能的影响效果，并设计参数。
石瑞. 代理集群的负载均衡系统设计与实现[D].哈尔滨工业大学,2011.
3.2.2 3.2.3节

3.基于云自适应遗传算法
杨越. 基于自适应小生境遗传算法的LVS负载均衡调度研究[D].西南交通大学,2013.
全面考虑静态参数、动态参数、输入指标、响应时间等参数。减轻通信压力，自适应。








